class MemoApp {
    constructor() {
        this.isAuthenticated = false;
        this.isRecording = false;
        this.recognition = null;
        this.spreadsheetId = null;
        
        this.initializeElements();
        this.initializeEventListeners();
        this.initializeGoogleAPI();
        this.initializeSpeechRecognition();
        this.loadCustomTags();
    }

    initializeElements() {
        // Ë™çË®ºÈñ¢ÈÄ£
        this.loginBtn = document.getElementById('loginBtn');
        this.userInfo = document.getElementById('userInfo');
        
        // ÂÖ•ÂäõÈñ¢ÈÄ£
        this.voiceBtn = document.getElementById('voiceBtn');
        this.textBtn = document.getElementById('textBtn');
        this.memoText = document.getElementById('memoText');
        this.voiceStatus = document.getElementById('voiceStatus');
        
        // „Çø„Ç∞Èñ¢ÈÄ£
        this.tagSelect = document.getElementById('tagSelect');
        this.addTagBtn = document.getElementById('addTagBtn');
        this.tagModal = document.getElementById('tagModal');
        this.newTagInput = document.getElementById('newTagInput');
        this.confirmTagBtn = document.getElementById('confirmTagBtn');
        this.cancelTagBtn = document.getElementById('cancelTagBtn');
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥
        this.saveBtn = document.getElementById('saveBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.statusMessage = document.getElementById('statusMessage');
    }

    initializeEventListeners() {
        // Ë™çË®º
        this.loginBtn.addEventListener('click', () => this.handleAuth());
        
        // ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø
        this.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
        this.textBtn.addEventListener('click', () => this.switchToTextInput());
        
        // „É°„É¢ÂÖ•Âäõ
        this.memoText.addEventListener('input', () => this.updateSaveButton());
        
        // „Çø„Ç∞ÁÆ°ÁêÜ
        this.addTagBtn.addEventListener('click', () => this.showTagModal());
        this.confirmTagBtn.addEventListener('click', () => this.addCustomTag());
        this.cancelTagBtn.addEventListener('click', () => this.hideTagModal());
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥
        this.saveBtn.addEventListener('click', () => this.saveMemo());
        this.clearBtn.addEventListener('click', () => this.clearMemo());
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ
        this.tagModal.addEventListener('click', (e) => {
            if (e.target === this.tagModal) this.hideTagModal();
        });
        
        // „Ç®„É≥„Çø„Éº„Ç≠„Éº„Åß„Çø„Ç∞ËøΩÂä†
        this.newTagInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.addCustomTag();
        });
    }

    async initializeGoogleAPI() {
        try {
            await new Promise((resolve, reject) => {
                gapi.load('auth2:client', resolve);
            });
            
            await gapi.client.init({
                apiKey: window.APP_CONFIG?.GOOGLE_API_KEY || 'YOUR_API_KEY_HERE',
                clientId: window.APP_CONFIG?.GOOGLE_CLIENT_ID || 'YOUR_CLIENT_ID_HERE',
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                scope: 'https://www.googleapis.com/auth/spreadsheets'
            });
            
            this.authInstance = gapi.auth2.getAuthInstance();
            this.updateAuthState();
            
        } catch (error) {
            console.error('Google APIÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            console.log('Ë©≥Á¥∞„Ç®„É©„Éº:', error.details || error.message);
            this.showMessage('Google API „ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error');
        }
    }

    initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            
            this.recognition.lang = 'ja-JP';
            this.recognition.continuous = true;
            this.recognition.interimResults = true;
            
            this.recognition.onstart = () => {
                this.isRecording = true;
                this.voiceStatus.classList.remove('hidden');
                this.voiceBtn.textContent = '‚èπÔ∏è ÂÅúÊ≠¢';
                this.voiceBtn.classList.add('active');
            };
            
            this.recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                this.memoText.value = finalTranscript + interimTranscript;
                this.updateSaveButton();
            };
            
            this.recognition.onend = () => {
                this.isRecording = false;
                this.voiceStatus.classList.add('hidden');
                this.voiceBtn.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
                this.voiceBtn.classList.remove('active');
            };
            
            this.recognition.onerror = (event) => {
                console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                this.showMessage('Èü≥Â£∞Ë™çË≠ò„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            };
            
            this.voiceBtn.disabled = false;
        } else {
            this.showMessage('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'info');
        }
    }

    async handleAuth() {
        if (!this.authInstance) {
            this.showMessage('Google API „ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
            return;
        }
        
        try {
            if (this.isAuthenticated) {
                await this.authInstance.signOut();
            } else {
                await this.authInstance.signIn();
            }
            this.updateAuthState();
        } catch (error) {
            console.error('Ë™çË®º„Ç®„É©„Éº:', error);
            this.showMessage('Ë™çË®º„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        }
    }

    updateAuthState() {
        if (!this.authInstance) return;
        
        this.isAuthenticated = this.authInstance.isSignedIn.get();
        
        if (this.isAuthenticated) {
            const user = this.authInstance.currentUser.get();
            const profile = user.getBasicProfile();
            
            this.loginBtn.textContent = '„É≠„Ç∞„Ç¢„Ç¶„Éà';
            this.userInfo.textContent = profile.getName();
            this.userInfo.classList.remove('hidden');
            this.saveBtn.disabled = false;
            
            this.initializeSpreadsheet();
        } else {
            this.loginBtn.textContent = 'Google„É≠„Ç∞„Ç§„É≥';
            this.userInfo.classList.add('hidden');
            this.saveBtn.disabled = true;
        }
    }

    async initializeSpreadsheet() {
        try {
            // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Çí‰ΩúÊàê„Åæ„Åü„ÅØÂèñÂæó
            const response = await gapi.client.sheets.spreadsheets.create({
                properties: {
                    title: 'Èü≥Â£∞„É°„É¢„Ç¢„Éó„É™ - ' + new Date().toLocaleDateString('ja-JP')
                }
            });
            
            this.spreadsheetId = response.result.spreadsheetId;
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÇíËøΩÂä†
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: this.spreadsheetId,
                range: 'A1:C1',
                valueInputOption: 'RAW',
                resource: {
                    values: [['Êó•ÊôÇ', '„Çø„Ç∞', '„É°„É¢ÂÜÖÂÆπ']]
                }
            });
            
            this.showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅåÊ∫ñÂÇô„Åß„Åç„Åæ„Åó„Åü', 'success');
            
        } catch (error) {
            console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            this.showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
    }

    toggleVoiceInput() {
        if (!this.recognition) {
            this.showMessage('Èü≥Â£∞Ë™çË≠ò„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'error');
            return;
        }
        
        if (this.isRecording) {
            this.recognition.stop();
        } else {
            this.memoText.value = '';
            this.recognition.start();
        }
    }

    switchToTextInput() {
        if (this.isRecording) {
            this.recognition.stop();
        }
        
        this.textBtn.classList.add('active');
        this.voiceBtn.classList.remove('active');
        this.memoText.focus();
    }

    updateSaveButton() {
        const hasContent = this.memoText.value.trim().length > 0;
        this.saveBtn.disabled = !hasContent || !this.isAuthenticated;
    }

    async saveMemo() {
        if (!this.isAuthenticated || !this.spreadsheetId) {
            this.showMessage('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            return;
        }
        
        const memoContent = this.memoText.value.trim();
        if (!memoContent) {
            this.showMessage('„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            return;
        }
        
        try {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            const tag = this.tagSelect.value;
            
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: this.spreadsheetId,
                range: 'A:C',
                valueInputOption: 'RAW',
                resource: {
                    values: [[timestamp, tag, memoContent]]
                }
            });
            
            this.showMessage('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            this.clearMemo();
            
        } catch (error) {
            console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
            this.showMessage('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
    }

    clearMemo() {
        this.memoText.value = '';
        this.updateSaveButton();
        this.memoText.focus();
    }

    showTagModal() {
        this.tagModal.classList.remove('hidden');
        this.newTagInput.focus();
    }

    hideTagModal() {
        this.tagModal.classList.add('hidden');
        this.newTagInput.value = '';
    }

    addCustomTag() {
        const newTag = this.newTagInput.value.trim();
        if (!newTag) {
            this.showMessage('„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            return;
        }
        
        // Êó¢Â≠ò„Çø„Ç∞„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
        const existingOptions = Array.from(this.tagSelect.options).map(opt => opt.value);
        if (existingOptions.includes(newTag)) {
            this.showMessage('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çø„Ç∞„Åß„Åô', 'error');
            return;
        }
        
        // „Çø„Ç∞„ÇíËøΩÂä†
        const option = document.createElement('option');
        option.value = newTag;
        option.textContent = `üè∑Ô∏è ${newTag}`;
        this.tagSelect.appendChild(option);
        this.tagSelect.value = newTag;
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
        this.saveCustomTags();
        
        this.hideTagModal();
        this.showMessage(`„Çø„Ç∞„Äå${newTag}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
    }

    saveCustomTags() {
        const customTags = Array.from(this.tagSelect.options)
            .map(opt => opt.value)
            .filter(tag => !['„É°„É¢', 'Êó•Ë®ò'].includes(tag));
        
        localStorage.setItem('customTags', JSON.stringify(customTags));
    }

    loadCustomTags() {
        try {
            const customTags = JSON.parse(localStorage.getItem('customTags') || '[]');
            customTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = `üè∑Ô∏è ${tag}`;
                this.tagSelect.appendChild(option);
            });
        } catch (error) {
            console.error('„Ç´„Çπ„Çø„É†„Çø„Ç∞„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        }
    }

    showMessage(text, type = 'info') {
        this.statusMessage.textContent = text;
        this.statusMessage.className = `status-message ${type}`;
        
        setTimeout(() => {
            this.statusMessage.textContent = '';
            this.statusMessage.className = 'status-message';
        }, 5000);
    }
}

// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    new MemoApp();
});

// PWA „Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„ÉºÁôªÈå≤
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(registration => console.log('SW registered:', registration))
        .catch(error => console.log('SW registration failed:', error));
}